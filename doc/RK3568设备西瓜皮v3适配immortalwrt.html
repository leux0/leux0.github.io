<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"leux.net","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/config.min.js"></script>



<link rel="canonical" href="https://leux.net/doc/RK3568%E8%AE%BE%E5%A4%87%E8%A5%BF%E7%93%9C%E7%9A%AEv3%E9%80%82%E9%85%8Dimmortalwrt.html">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://leux.net/doc/RK3568%E8%AE%BE%E5%A4%87%E8%A5%BF%E7%93%9C%E7%9A%AEv3%E9%80%82%E9%85%8Dimmortalwrt.html","path":"doc/RK3568设备西瓜皮v3适配immortalwrt.html","title":"RK3568设备西瓜皮v3适配immortalwrt"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>RK3568设备西瓜皮v3适配immortalwrt | 云端笔记</title>
  

  <script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/third-party/analytics/baidu-analytics.min.js"></script>
  <script async src="https://hm.baidu.com/hm.js?48ca531a11053ad348525e965c3ca451"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">云端笔记</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习的备忘录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">109</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">7</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">21</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%82%E9%85%8D%E8%AE%BE%E5%A4%87%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">适配设备信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">获取官方源码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E9%80%82%E9%85%8D%E8%AE%BE%E5%A4%87"><span class="nav-number">3.</span> <span class="nav-text">开始适配设备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8-SPI%E5%B1%8F%E5%B9%95"><span class="nav-number">4.</span> <span class="nav-text">驱动 SPI屏幕</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-number">5.</span> <span class="nav-text">其他优化项目</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">leux</p>
  <div class="site-description" itemprop="description">好记性不如烂笔头</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://leux.net/doc/RK3568%E8%AE%BE%E5%A4%87%E8%A5%BF%E7%93%9C%E7%9A%AEv3%E9%80%82%E9%85%8Dimmortalwrt.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="leux">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="云端笔记">
      <meta itemprop="description" content="好记性不如烂笔头">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="RK3568设备西瓜皮v3适配immortalwrt | 云端笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RK3568设备西瓜皮v3适配immortalwrt
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-05-29 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-29T00:00:00+00:00">2025-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>&nbsp;<span id="more"></span></p>
<h1 id="适配设备信息"><a href="#适配设备信息" class="headerlink" title="适配设备信息"></a>适配设备信息</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NL68K 西瓜皮V3购买链接：https://item.taobao.com/item.htm?id=711773675433</span></span><br><span class="line"><span class="comment"># MINIPCIE转5G模块转接板：https://item.taobao.com/item.htm?id=694045271626</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 西瓜皮v3硬件配置，包括核心板V3一片，西瓜皮V3底板一片</span></span><br><span class="line">CPU：瑞芯微 RK3568 四核64位Cortex-A55  Mail-G52  RK817-5</span><br><span class="line">ROM：闪迪 SanDisk SDINBDA4-32G   32GB eMMC</span><br><span class="line">RAM：长鑫  CXMT   CXDB5CCBM-MK-A  4GB LPDDR4X</span><br><span class="line"></span><br><span class="line">2个 RTL8211F 自带千兆网口</span><br><span class="line">2个 MINIPCIE 接口，带5V电源PA供电专用，可插PCIE的WIFI网卡</span><br><span class="line">1个 M.2 B Key接口，支持RM500Q同尺寸的 5G 模块(52×30×2.3mm)</span><br><span class="line">1个 M.2 E Key接口，支持MT7922同尺寸的WiFi网卡(22x30x2.3mm)</span><br><span class="line">1个 USBA3 OTG接口    1个 HDMI2.0输出接口    1个 TF卡槽    1个 SIM卡槽</span><br><span class="line">1个 DC 5521规格的电源插头，可使用5V-18V 1-3A</span><br><span class="line">1个 FPC接口的 SPI/I2C 显示屏接口，CNC外壳上带的SPI屏幕驱动IC为GC9307</span><br><span class="line">1个 可自动根据CPU温度调节风扇转速的5V风扇接口 MX1.25 4pin PWM调速</span><br><span class="line">3个 LED指示灯         3个按钮：| ⊙ 刷机键 | ↺ 重启键 | ○ 恢复键 |</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最新消息：西瓜皮V3已于20250813合并到了lean lede项目：https://github.com/coolsnowwolf/lede/commit/8547db9c25d697d9d966f8f8e91c6a74066ff243</span></span><br></pre></td></tr></table></figure>


<h1 id="获取官方源码"><a href="#获取官方源码" class="headerlink" title="获取官方源码"></a>获取官方源码</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码（--single-branch 仅下载单个分支/标签、--depth=1 只下载最新的一次提交、-b 指定分支/标签）</span></span><br><span class="line">git <span class="built_in">clone</span> --depth=1 -b v24.10.2 https://github.com/immortalwrt/immortalwrt</span><br><span class="line"><span class="built_in">cd</span> immortalwrt/</span><br><span class="line">git pull</span><br><span class="line">./scripts/feeds update -a</span><br><span class="line">./scripts/feeds install -a</span><br><span class="line"></span><br><span class="line">make menuconfig				<span class="comment"># 进入固件配置界面增减改查</span></span><br><span class="line">make download V=s -j$(<span class="built_in">nproc</span>)		<span class="comment"># 请尽量用梯子下载所需源码</span></span><br><span class="line">make V=s -j$(<span class="built_in">nproc</span>)			<span class="comment"># 若编译出错请用单线程调错</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用网卡驱动所需驱动包，MT7921有3种版本，E是PCIE，S是SDIO，U是USB，没别的区分。RTL8852也有多种版本</span></span><br><span class="line">MT7915/MT7916				kmod-mt7915e kmod-mt7915-firmware kmod-mt7916-firmware</span><br><span class="line">MT7921/MT7922/MT7925E			kmod-mt7921[e/s/u] kmod-mt7921-firmware kmod-mt7922-firmware kmod-mt7925e kmod-mt7925-firmware</span><br><span class="line">AX500-DBS/NFA765			kmod-ath11k kmod-ath11k-pci ath11k-firmware-qca6390 ath11k-firmware-wcn6855</span><br><span class="line">AX200/AX210/BE200			kmod-iwlwifi iwlwifi-firmware-ax200 iwlwifi-firmware-ax210 iwlwifi-firmware-be200</span><br><span class="line">RTL8852[A/B/C]E/RTL8922AE		kmod-rtw89-8852[a/b/c]e rtl8852[a/b/c]e-firmware kmod-rtw89-8922ae rtl8922ae-firmware</span><br><span class="line"></span><br><span class="line"><span class="comment"># 蓝牙固件</span></span><br><span class="line">MT7921/MT7922				mt7921bt-firmware mt7922bt-firmware</span><br></pre></td></tr></table></figure>


<h1 id="开始适配设备"><a href="#开始适配设备" class="headerlink" title="开始适配设备"></a>开始适配设备</h1><ol>
<li>在 <code>target/linux/rockchip/image/armv8.mk</code> 文件最后添加如下内容，使其出现在 <code>make menuconfig</code> 里面</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># target/linux/rockchip/image/armv8.mk</span></span><br><span class="line"></span><br><span class="line">define Device/nlnet_xiguapi-v3</span><br><span class="line">  DEVICE_VENDOR := NLnet</span><br><span class="line">  DEVICE_MODEL := XiGuaPi V3</span><br><span class="line">  SOC := rk3568</span><br><span class="line">  DEVICE_DTS := rockchip/rk3568-xiguapi-v3</span><br><span class="line">  UBOOT_DEVICE_NAME := xgp-rk3568</span><br><span class="line">  BOOT_FLOW := pine64-img</span><br><span class="line">  DEVICE_PACKAGES := wpad-openssl kmod-mt7916-firmware kmod-r8169 kmod-usb-net-rndis \</span><br><span class="line">    usbutils pciutils luci luci-ssl-openssl luci-proto-ncm luci-proto-qmi luci-proto-mbim</span><br><span class="line">endef</span><br><span class="line">TARGET_DEVICES += nlnet_xiguapi-v3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加适配设备名到指定文件使其可初始化网络和优化网络设备性能，记得不要包含 <code>+</code> 号哦</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将如下带 + 的行添加到：target/linux/rockchip/armv8/base-files/etc/board.d/02_network</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rockchip_setup_interfaces</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">local</span> board=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;<span class="variable">$board</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">+	nlnet,xiguapi-v3|\</span><br><span class="line">	armsom,sige7|\</span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="title">rockchip_setup_macs</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">local</span> board=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">	<span class="built_in">local</span> lan_mac=<span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="built_in">local</span> wan_mac=<span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="built_in">local</span> label_mac=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;<span class="variable">$board</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">+	nlnet,xiguapi-v3|\</span><br><span class="line">	armsom,sige3|\</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment"># 将如下带 + 的行添加到：target/linux/rockchip/armv8/base-files/etc/hotplug.d/net/40-net-smp-affinity</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;<span class="subst">$(board_name)</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">+ nlnet,xiguapi-v3|\</span><br><span class="line">  armsom,sige3|\</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在内核源码中为需要适配的设备添加设备树源码文件</li>
</ol>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 将要适配设备的内核设备树源码文件放到指定位置，这样在Immortalwrt构建时该文件便会复制到内核源码中对应的位置</span><br><span class="line">wget -O target/linux/rockchip/files/arch/arm64/boot/dts/rockchip/rk3568-xiguapi-v3.dts \</span><br><span class="line">https://github.com/coolsnowwolf/lede/raw/master/target/linux/rockchip/files/arch/arm64/boot/dts/rockchip/rk3568-xiguapi-v3.dts</span><br><span class="line"></span><br><span class="line"># 有了DTS还需要在Makefile中添加它，在如下补丁中添加最后那条带 + 的行，建议直接用它替换补丁中已存在的行，使其在编译时应用补丁到内核源码中</span><br><span class="line"><span class="comment">---------- target/linux/rockchip/patches-6.6/900-arm64-boot-add-dts-files.patch ----------</span></span><br><span class="line">diff -Nur a/arch/arm64/boot/dts/rockchip/Makefile b/arch/arm64/boot/dts/rockchip/Makefile</span><br><span class="line"><span class="comment">--- a/arch/arm64/boot/dts/rockchip/Makefile</span></span><br><span class="line"><span class="comment">+++ b/arch/arm64/boot/dts/rockchip/Makefile</span></span><br><span class="line"><span class="meta">@@ -114,3 +114,4 @@</span></span><br><span class="line"> dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-r6s.dtb</span><br><span class="line"> dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-nanopi-r6c.dtb</span><br><span class="line"> dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3588s-rock-5a.dtb</span><br><span class="line"><span class="addition">+dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3568-xiguapi-v3.dtb</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在<code>U-Boot</code>中添加本适配的设备</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先在 package/boot/uboot-rockchip/Makefile 中添加本适配设备</span></span><br><span class="line"></span><br><span class="line">define U-Boot/xgp-rk3568</span><br><span class="line">  $(U-Boot/rk3568/Default)</span><br><span class="line">  NAME:=NLnet XiGuaPi Board</span><br><span class="line">  BUILD_DEVICES:= \</span><br><span class="line">    nlnet_xiguapi-v3</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">UBOOT_TARGETS := \</span><br><span class="line">  xgp-rk3568 \</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里使用上面LEDE中别人适配好的内核设备树源码文件并删除其中的rng节点后再作为U-Boot里的设备树源码文件</span></span><br><span class="line">wget -O package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-xgp.dts \</span><br><span class="line">https://github.com/coolsnowwolf/lede/raw/master/target/linux/rockchip/files/arch/arm64/boot/dts/rockchip/rk3568-xiguapi-v3.dts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除第671~674行的rng节点，不删除rng节点编译U-Boot时会报错：Error: arch/arm/dts/.rk3568-xgp.dtb.pre.tmp:671.1-5 Label or path rng not found</span></span><br><span class="line">sed -i <span class="string">&#x27;671,674d&#x27;</span> package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-xgp.dts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后U-Boot中的dtsi直接使用Immortalwrt中已支持的相似设备 莱因特T68M 的就行</span></span><br><span class="line"><span class="built_in">cp</span> package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-lyt-t68m-u-boot.dtsi package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-xgp-u-boot.dtsi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 至于U-Boot的配置文件也是直接使用 莱因特T68M 的配置文件再修改部分地方即可</span></span><br><span class="line"><span class="built_in">cp</span> package/boot/uboot-rockchip/src/configs/lyt-t68m-rk3568_defconfig package/boot/uboot-rockchip/src/configs/xgp-rk3568_defconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上面拷贝的 莱因特T68M 配置文件中的设备树修改为要适配设备的：package/boot/uboot-rockchip/src/configs/xgp-rk3568_defconfig</span></span><br><span class="line"><span class="comment"># CONFIG_DEFAULT_DEVICE_TREE=&quot;rk3568-lyt-t68m&quot;			替换为	CONFIG_DEFAULT_DEVICE_TREE=&quot;rk3568-xgp&quot;</span></span><br><span class="line"><span class="comment"># CONFIG_DEFAULT_FDT_FILE=&quot;rockchip/rk3568-lyt-t68m.dtb&quot;	替换为	CONFIG_DEFAULT_FDT_FILE=&quot;rockchip/rk3568-xiguapi-v3.dtb&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>适配过程中用到的相关变量和文件及解析</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># target/linux/rockchip/image/armv8.mk</span></span><br><span class="line">define Device/nlnet_xiguapi-v3			<span class="comment"># 该定义的设备名将在 package/boot/uboot-rockchip/Makefile 中被定义设备的 BUILD_DEVICES 内引用</span></span><br><span class="line">  DEVICE_VENDOR := NLnet</span><br><span class="line">  DEVICE_MODEL := XiGuaPi V3			<span class="comment"># 其在 menuconfig 菜单中显示为 $(DEVICE_VENDOR) + $(DEVICE_MODEL) 即为：NLnet XiGuaPi V3</span></span><br><span class="line">  SOC := rk3568</span><br><span class="line">  DEVICE_DTS := rockchip/rk3568-xiguapi-v3	<span class="comment"># 指定使用的设备树为 linux/arch/arm64/boot/dts/rockchip/rk3568-xiguapi-v3.dts</span></span><br><span class="line">  UBOOT_DEVICE_NAME := xgp-rk3568		<span class="comment"># 指定该设备在U-Boot中对应的设备名为：xgp-rk3568</span></span><br><span class="line">  BOOT_FLOW := pine64-img			<span class="comment"># 生成镜像使用的分区表及引导相关信息，其在 target/linux/rockchip/image/Makefile 中被定义</span></span><br><span class="line">  DEVICE_PACKAGES := kmod-r8169			<span class="comment"># 该设备依赖的软件包，选定该设备即这些软件包将全部包含</span></span><br><span class="line">endef</span><br><span class="line">TARGET_DEVICES += nlnet_xiguapi-v3		<span class="comment"># 添加该设备到 TARGET_DEVICES 中使其可在 menuconfig 菜单中显示</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################################################################################</span></span><br><span class="line"><span class="comment"># package/boot/uboot-rockchip/Makefile</span></span><br><span class="line">define U-Boot/xgp-rk3568			<span class="comment"># 与 armv8.mk 中定义的 UBOOT_DEVICE_NAME 匹配并与同文件后面 UBOOT_TARGETS 中对应</span></span><br><span class="line">  $(U-Boot/rk3568/Default)</span><br><span class="line">  NAME:=NLnet XiGuaPi Board			<span class="comment"># 在 U-Boot 的 menuconfig 菜单中显示的设备名，它在这里并不重要</span></span><br><span class="line">  BUILD_DEVICES:= \</span><br><span class="line">    nlnet_xiguapi-v3				<span class="comment"># 与 armv8.mk 中定义的设备名 define Device/nlnet_xiguapi-v3 对应</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">UBOOT_TARGETS := \</span><br><span class="line">  xgp-rk3568 \					<span class="comment"># 与上面 define U-Boot/xgp-rk3568 定义的设备名相对应</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 package/boot/uboot-rockchip/Makefile 中的 define U-Boot/xgp-rk3568 指定了配置文件为：package/boot/uboot-rockchip/src/configs/xgp-rk3568_defconfig</span></span><br><span class="line"><span class="comment"># 在 xgp-rk3568_defconfig 中 CONFIG_DEFAULT_DEVICE_TREE=&quot;rk3568-xgp&quot; 指定了其使用的DTS为：package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-xgp.dts</span></span><br><span class="line"><span class="comment"># 在 xgp-rk3568_defconfig 中 CONFIG_DEFAULT_FDT_FILE 指定了U-Boot中变量 $&#123;fdtfile&#125; 的值，但因为在OpenWrt中内核与设备树合并成了 kernel.img 所以也用不上它</span></span><br><span class="line"><span class="comment"># 若 CONFIG_DEFAULT_DEVICE_TREE=&quot;rockchip/rk3568-xgp&quot; 则DTS文件应位于：package/boot/uboot-rockchip/src/arch/arm/dts/rockchip/rk3568-xgp.dts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要是你不用 莱因特T68M 转而使用官方支持的相近配置的设备 Armsom-Sige3 的 u-boot.dtsi 和U-Boot设备树及U-Boot配置文件需要注意如下：</span></span><br><span class="line"><span class="comment"># 拷贝的 Armsom-Sige3 配置文件不修改也能直接用，但因用的是Sige3的设备树，在U-Boot中会显示为：Model: ArmSoM Sige3 但不影响正常启动</span></span><br><span class="line"><span class="comment"># 若不想U-Boot中显示为 Model: ArmSoM Sige3 的话（没啥用，反正也看不见），把上面复制的设备树 rk3568-xgp.dts 中如下字段用西瓜皮的替换即可</span></span><br><span class="line"><span class="comment"># model = &quot;ArmSom Sige3&quot;;					model = &quot;NLnet XiGuaPi V3&quot;;</span></span><br><span class="line"><span class="comment"># compatible = &quot;armsom,sige3&quot;, &quot;rockchip,rk3568&quot;;		compatible = &quot;nlnet,xiguapi-v3&quot;, &quot;rockchip,rk3568&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 适配设备U-Boot需要添加修改的相关文件或变量，以 generic-rk3568 设备为例（在本次适配系统中的 u-boot-2024.10 内已包含了 generic-rk3568 设备的如下相关文件）</span></span><br><span class="line"><span class="built_in">arch</span>/arm/dts/rk3568-generic.dts</span><br><span class="line"><span class="built_in">arch</span>/arm/dts/rk3568-generic-u-boot.dtsi</span><br><span class="line">configs/generic-rk3568_defconfig</span><br><span class="line">CONFIG_DEFAULT_DEVICE_TREE=<span class="string">&quot;rk3568-generic&quot;</span></span><br><span class="line">CONFIG_DEFAULT_FDT_FILE=<span class="string">&quot;rockchip/rk3568-generic.dtb&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="驱动-SPI屏幕"><a href="#驱动-SPI屏幕" class="headerlink" title="驱动 SPI屏幕"></a>驱动 SPI屏幕</h1><ol>
<li><p>自带的SPI屏幕驱动器为GC9307，而它几乎与ST7789V相同，所以这里拿ST7789V模块改下来用</p>
</li>
<li><p>首先在 <code>immortalwrt/package/kernel/linux/modules/video.mk</code> 中添加如下内容使能在菜单中选择<code>ST7789V</code>内核模块</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 menuconfig 中的位置 &gt; Kernel modules &gt; Video Support &gt; &lt;*&gt; kmod-fb-tft-st7789v</span></span><br><span class="line"></span><br><span class="line">define KernelPackage/fb-tft-st7789v</span><br><span class="line">  SUBMENU:=$(VIDEO_MENU)</span><br><span class="line">  TITLE:=FB driver <span class="keyword">for</span> the ST7789V LCD Controller</span><br><span class="line">  DEPENDS:=+kmod-fb-tft</span><br><span class="line">  KCONFIG:=CONFIG_FB_TFT_ST7789V</span><br><span class="line">  FILES:=$(LINUX_DIR)/drivers/staging/fbtft/fb_st7789v.ko</span><br><span class="line">  AUTOLOAD:=$(call AutoLoad,09,fb_st7789v)</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">define KernelPackage/fb-tft-st7789v/description</span><br><span class="line">  FB driver <span class="keyword">for</span> the ST7789V LCD Controller</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">eval</span> $(call KernelPackage,fb-tft-st7789v))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>再将如下内容的补丁放到 <code>immortalwrt/target/linux/rockchip/patches-6.6/999-Add-GC9307.patch</code> 中使内核能驱动这款屏幕</li>
</ol>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/drivers/staging/fbtft/fb_st7789v.c</span></span><br><span class="line"><span class="comment">+++ b/drivers/staging/fbtft/fb_st7789v.c</span></span><br><span class="line"><span class="meta">@@ -28,7 +28,7 @@</span></span><br><span class="line"> 	&quot;D0 05 0A 09 08 05 2E 44 45 0F 17 16 2B 33\n&quot; \</span><br><span class="line"> 	&quot;D0 05 0A 09 08 05 2E 43 45 0F 16 16 2B 33&quot;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#define HSD20_IPS 1</span></span><br><span class="line"><span class="addition">+#define HSD20_IPS 0</span></span><br><span class="line"> </span><br><span class="line"> /**</span><br><span class="line">  * enum st7789v_command - ST7789V display controller commands</span><br><span class="line"><span class="meta">@@ -289,7 +289,7 @@</span></span><br><span class="line"> 	default:</span><br><span class="line"> 		return -EINVAL;</span><br><span class="line"> 	&#125;</span><br><span class="line"><span class="deletion">-	write_reg(par, MIPI_DCS_SET_ADDRESS_MODE, madctl_par);</span></span><br><span class="line"><span class="addition">+	write_reg(par, MIPI_DCS_SET_ADDRESS_MODE, 0x38);</span></span><br><span class="line"> 	return 0;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>还需修改内核设备树中的spi3节点与内核源码文件中的内容相匹配来将设备和驱动绑定起来</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 本文中LEDE的dts中已有spi3节点仅需修改其中的 compatible = <span class="string">&quot;galaxycore,gc9307&quot;</span> 为 compatible = <span class="string">&quot;sitronix,st7789v&quot;</span> 即可</span><br><span class="line"># 因为内核源码 drivers/staging/fbtft/fb_st7789v.c 中的如下内容要与dts中spi3节点的 compatible 相匹配</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRVNAME <span class="string">&quot;fb_st7789v&quot;</span>							<span class="comment">// define DRVNAME &quot;fb_gc9307&quot;</span></span></span><br><span class="line">......</span><br><span class="line">FBTFT_REGISTER_DRIVER(DRVNAME, <span class="string">&quot;sitronix,st7789v&quot;</span>, &amp;display);			<span class="comment">// FBTFT_REGISTER_DRIVER(DRVNAME, &quot;galaxycore,gc9307&quot;, &amp;display);</span></span><br><span class="line"></span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;spi:&quot;</span> DRVNAME);</span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;platform:&quot;</span> DRVNAME);</span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;spi:st7789v&quot;</span>);							<span class="comment">// MODULE_ALIAS(&quot;spi:gc9307&quot;);</span></span><br><span class="line">MODULE_ALIAS(<span class="string">&quot;platform:st7789v&quot;</span>);						<span class="comment">// MODULE_ALIAS(&quot;platform:gc9307&quot;);</span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;FB driver for the ST7789V LCD Controller&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>若使用其他人的设备树需要修改 <code>immortalwrt/target/linux/rockchip/files/arch/arm64/boot/dts/rockchip/rk3568-xgp*.dts</code> 中的spi3节点为如下内容</li>
</ol>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="variable">&amp;spi3</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">	pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;spi3m1_cs0</span> <span class="variable">&amp;spi3_sck</span> <span class="variable">&amp;spi3_mosi</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="title class_">display@0</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span><span class="punctuation">;</span></span><br><span class="line">		pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;spi3_display_dc_pin</span> <span class="variable">&amp;display_reset_pin</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;sitronix,st7789v&quot;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">rotate</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">270</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">dc-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio4</span> RK_PC5 GPIO_ACTIVE_HIGH&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">reset-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpio4</span> RK_PC4 GPIO_ACTIVE_LOW&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">backlight</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;backlight</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">buswidth</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">8</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">debug</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">mirror-y</span><span class="punctuation">;</span></span><br><span class="line">		<span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line">......</span><br><span class="line"><span class="variable">&amp;pinctrl</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="title class_">spi3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">		spi3_sck:</span> <span class="title class_">spi3_sck</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">4</span> RK_PC2 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">		spi3_mosi:</span> <span class="title class_">spi3_mosi</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">4</span> RK_PC3 <span class="number">2</span> <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">display</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">		spi3_display_dc_pin:</span> <span class="title class_">spi3_display_dc_pin</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">4</span> RK_PC5 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">		display_reset_pin:</span> <span class="title class_">display_reset_pin</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">4</span> RK_PC4 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">backlight</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">		backlight_led_pin:</span> <span class="title class_">backlight-led-pin</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">rockchip,pins</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3</span> RK_PA2 RK_FUNC_GPIO <span class="variable">&amp;pcfg_pull_none</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">		<span class="punctuation">&#125;;</span></span><br><span class="line">	<span class="punctuation">&#125;;</span></span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>内核显示输出及简单的显示测试</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ImmortalWrt:~# dmesg | grep fb</span><br><span class="line">[    9.233927] fbtft: module is from the staging directory, the quality is unknown, you have been warned.</span><br><span class="line">[    9.251168] fb_st7789v: module is from the staging directory, the quality is unknown, you have been warned.</span><br><span class="line">[    9.252287] SPI driver fb_st7789v has no spi_device_id <span class="keyword">for</span> sitronix,st7789v</span><br><span class="line">[    9.253148] fb_st7789v spi3.0: fbtft_property_value: buswidth = 8</span><br><span class="line">[    9.253693] fb_st7789v spi3.0: fbtft_property_value: backlight = 157</span><br><span class="line">[    9.254256] fb_st7789v spi3.0: fbtft_property_value: debug = 0</span><br><span class="line">[    9.254772] fb_st7789v spi3.0: fbtft_property_value: rotate = 270</span><br><span class="line">[    9.530937] graphics fb0: fb_st7789v frame buffer, 320x240, 150 KiB video memory, 4 KiB buffer memory, fps=20, spi3.0 at 50 MHz</span><br><span class="line">root@ImmortalWrt:~#</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供两个简单的测试方法</span></span><br><span class="line"><span class="built_in">cat</span> /dev/urandom &gt; /dev/fb0		<span class="comment"># 显示花屏</span></span><br><span class="line"><span class="built_in">cat</span> /dev/zero &gt; /dev/fb0		<span class="comment"># 清空屏幕，也就是黑屏</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分享一个适用于西瓜皮v3屏幕的显示程序项目，但其5G模块信息依赖Python3和QModem项目</span></span><br><span class="line">https://github.com/zzzz0317/xgp-v3-screen/</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="其他优化项目"><a href="#其他优化项目" class="headerlink" title="其他优化项目"></a>其他优化项目</h1><ol>
<li>首次开机时自动执行命令和修改配置，根据你的需求及配置修改，这里仅提供简单的示例</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 /etc/uci-defaults/ 目录中的所有脚本都会被 /etc/init.d/boot 服务自动执行并在成功执行后删除，脚本名称前面的数字大小代表启动顺序</span></span><br><span class="line"><span class="comment"># 它们若没有发生错误的情况下正常结束或以 exit 0 退出后会被删除。而执行失败发生错误以非零代码退出的脚本不会被删除，并将在下次启动时重新执行，直到它们也正常结束</span></span><br><span class="line"><span class="comment"># 更多相关信息请查看：https://openwrt.org/zh/docs/guide-developer/uci-defaults</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建 immortalwrt/package/base-files/files/etc/uci-defaults/99-custom 文件内容如下使其首次开机自动配置LAN地址和无线网络</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 设置主机名和时区后提交保存</span></span><br><span class="line">uci <span class="built_in">set</span> system.@system[0].hostname=<span class="string">&quot;XGP&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> system.@system[0].timezone=<span class="string">&quot;CST-8&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> system.@system[0].zonename=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">uci commit system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置后台地址</span></span><br><span class="line">uci <span class="built_in">set</span> network.lan.ipaddr=<span class="string">&quot;192.168.100.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置第一个无线接口信息为如下，这个不通用请根据你的无线网卡配置来写</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-device[0].band=<span class="string">&#x27;5g&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-device[0].channel=<span class="string">&#x27;36&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-device[0].country=<span class="string">&#x27;US&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-device[0].htmode=<span class="string">&#x27;HE80&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-device[0].disabled=<span class="string">&#x27;0&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-iface[0].disabled=<span class="string">&#x27;0&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-iface[0].encryption=<span class="string">&#x27;psk2&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-iface[0].ssid=<span class="string">&quot;Immortalwrt&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> wireless.@wifi-iface[0].key=<span class="string">&quot;12345678&quot;</span></span><br><span class="line">uci commit wireless</span><br><span class="line"></span><br><span class="line">/etc/init.d/network reload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加QModem移动模组管理程序</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加该项目源码后更新并安装，然后就可以在后面的 menuconfig 中选择构建使用了</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;src-git qmodem https://github.com/FUjr/QModem.git;main&#x27;</span> &gt;&gt; feeds.conf.default</span><br><span class="line">./scripts/feeds update qmodem</span><br><span class="line">./scripts/feeds install -a -p qmodem</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt; LuCI &gt; 3. Applications &gt; &lt;*&gt; luci-app-qmodem</span></span><br><span class="line">  │ │              -*- luci-app-qmodem.............................. LuCI support <span class="keyword">for</span> QWRT Modem       │ │</span><br><span class="line">  │ │                  Qualcomm QMI WWAN Driver Selection (Vendor QMI driver)  ---&gt;                    │ │</span><br><span class="line">  │ │                  Quectel Connect Manager Selection (Tom customized Quectel CM)  ---&gt;             │ │</span><br><span class="line">  │ │              [*] Add PCIe Modem SUPPORT                                                          │ │</span><br><span class="line">  │ │              [*] Add MTK-T7XX Modem PCI SUPPORT                                                  │ │</span><br><span class="line">  │ │              [*] Add Qfirehose SUPPORT                                                           │ │</span><br><span class="line">  │ │              &lt; &gt; luci-app-qmodem-hc............................ Luci qwrt modem sim switch       │ │</span><br><span class="line">  │ │              &lt; &gt; luci-app-qmodem-mwan........................ Luci qwrt modem mwan support       │ │</span><br><span class="line">  │ │              &lt;*&gt; luci-app-qmodem-sms.......................... Luci qwrt modem sms support       │ │</span><br><span class="line">  │ │              &lt; &gt; luci-app-qmodem-ttl.......................... Luci qwrt modem ttl support       │ │</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：luci-app-qmodem 与 luci-proto-quectel 中的 quectel-cm 中的如下两个依赖包冲突。在 immortalwrt/feeds/packages/net/quectel-cm/Makefile 中有记载</span></span><br><span class="line">    +kmod-usb-net-qmi-wwan-fibocom \</span><br><span class="line">    +kmod-usb-net-qmi-wwan-quectel \</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>解决EMMC和SD卡均刷OpenWrt后U-Boot的启动问题</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若EMMC和SD卡都用的是OpenWrt中的主线U-Boot 2024.10则会导致SD卡启动时内核用SD卡上的而RootFS依旧用EMMC上的，但分别用不同的就没问题</span></span><br><span class="line"><span class="comment"># 解决方法是EMMC上刷个用Rockchip U-Boot-2017.09的系统，而SD卡则可随意刷OpenWrt U-Boot 2024.10之类的系统，这样OpenWrt在SD卡启动就没问题了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我这里刷入创建的空镜像盘来清空EMMC但保留其U-Boot，或者你也可以直接将EMMC刷Armbian系统</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=zero.img bs=1M count=64							<span class="comment"># 创建一个64M的空镜像</span></span><br><span class="line">losetup -f -P zero.img										<span class="comment"># 挂载上面创建的空镜像</span></span><br><span class="line">parted -s /dev/loop0 mklabel gpt								<span class="comment"># 为镜像创建GPT分区表</span></span><br><span class="line">parted -s /dev/loop0 mkpart primary ext4 16777216b 100%						<span class="comment"># 保留前16M后新建分区</span></span><br><span class="line">mkfs.ext4 /dev/loop0p1										<span class="comment"># 格式化分区为EXT4型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里用的是Flippy提供的Rockchip U-Boot-2017.09，想用它引导系统请参考 armbianEnv.txt 那一套，与OpenWrt现在用的有差别</span></span><br><span class="line"><span class="comment"># 刷入读取时需要跳过U-Boot文件前32KB的数据（因为该文件包含未知的分区表信息）。写入时同样跳过空镜像文件前32KB的数据（因其保存的是本镜像的分区表信息）</span></span><br><span class="line">wget https://github.com/unifreq/openwrt_packit/raw/master/files/rk3568/h68k/bootloader.bin</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=bootloader.bin of=/dev/loop0 conv=fsync,notrunc bs=512 skip=64 seek=64			<span class="comment"># 镜像写入U-Boot文件</span></span><br><span class="line">losetup -D											<span class="comment"># 卸载镜像后即可刷入</span></span><br><span class="line"></span><br><span class="line">———————————————————————————————————————————————————————————————————————————————————————————————</span><br><span class="line"><span class="comment"># 说点题外话：RK356X默认u-boot的SPL有个启动次序，比如 MMC1 -&gt; MMC0，而RK356X的MMC又大致分为3种设备：</span></span><br><span class="line">SDMMC	sdmmc用于SD卡通信</span><br><span class="line">SDHCI	sdhci用于EMMC通信</span><br><span class="line">SDIO	sdio用于wifi等外设通信</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在源码 u-boot-2024.10/include/configs/rockchip-common.h 中已经定义了默认的启动顺序如下：</span></span><br><span class="line"><span class="comment">#define BOOT_TARGETS	&quot;mmc1 mmc0 nvme scsi usb pxe dhcp spi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在源码 u-boot-2024.10/arch/arm/dts/rk356x-u-boot.dtsi 中默认的SPL启动顺序如下：</span></span><br><span class="line">	aliases &#123;</span><br><span class="line">		mmc0 = &amp;sdhci;</span><br><span class="line">		mmc1 = &amp;sdmmc0;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	chosen &#123;</span><br><span class="line">		u-boot,spl-boot-order = <span class="string">&quot;same-as-spl&quot;</span>, &amp;sdmmc0, &amp;sdhci;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所以若是sdhci即EMMC设为mmc0，sdmmc即SD卡设为mmc1，逻辑上看是当有mmc1即SD卡存在时，便会从其启动。SD卡不存在时，则从mmc0启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这些默认定义和启动顺序可能存在但不限于如下等文件中：</span></span><br><span class="line">u-boot-2024.10/arch/arm/dts/rk356x-u-boot.dtsi</span><br><span class="line">package/boot/uboot-rockchip/src/arch/arm/dts/rk3568-xgp.dts</span><br><span class="line">target/linux/rockchip/files/arch/arm64/boot/dts/rockchip/rk3568-xiguapi-v3.dts</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改构建后系统默认使用的软件源</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以将源地址 https://downloads.immortalwrt.org 或 https://mirrors.vsean.net/openwrt 更改为 https://mirrors.cernet.edu.cn/immortalwrt 为例</span></span><br><span class="line"><span class="comment"># 将该文件中 opkg_mirror 值修改为如下即可：immortalwrt/package/emortal/default-settings/files/99-default-settings-chinese</span></span><br><span class="line">opkg_mirror=<span class="string">&quot;https://mirrors.vsean.net/openwrt&quot;</span>		修改为		opkg_mirror=<span class="string">&quot;https://mirrors.cernet.edu.cn/immortalwrt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 而默认的自定义源存储在：immortalwrt/package/system/opkg/files/customfeeds.conf</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调整内核后缀与immortalwrt官方源中版本一致来使用官方源中的内核模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先请在官方的配置文件上增减软件包，因为官方内核中启用了BTF功能，而自编的没有将导致自编译的系统无法使用官方源中的内核模块</span></span><br><span class="line">wget -O .config https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/targets/rockchip/armv8/config.buildinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 但官方的配置文件包含了大量我们不需要的选项，它会延长编译时间降低我们的效率，请在 make menuconfig 中按需去除</span></span><br><span class="line">[ ] Build the OpenWrt Image Builder</span><br><span class="line">[ ] Build the OpenWrt SDK</span><br><span class="line">[ ] Build the LLVM-BPF toolchain tarball</span><br><span class="line">[ ] Package the OpenWrt-based Toolchain</span><br><span class="line">&gt; Global build settings </span><br><span class="line">    [ ] Create JSON info file overview per target</span><br><span class="line">    [ ] Create CycloneDX SBOM JSON</span><br><span class="line">    [ ] Select all target specific packages by default</span><br><span class="line">    [ ] Select all kernel module packages by default</span><br><span class="line">    [ ] Select all userspace packages by default</span><br><span class="line">    [ ] Set build defaults <span class="keyword">for</span> automatic builds (e.g. via buildbot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后查看要用的immortalwrt源中内核的版本信息</span></span><br><span class="line">leux@Debian:~$ curl -s https://downloads.immortalwrt.org/releases/24.10.2/targets/rockchip/armv8/immortalwrt-24.10.2-rockchip-armv8.manifest | grep kernel</span><br><span class="line">kernel - 6.6.93~9e686cc1e0d5129337ca1ca28c2ab984-r1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 immortalwrt/include/kernel-defaults.mk 中第 130 行如下内容注释并在其后添加另一行</span></span><br><span class="line">......</span><br><span class="line">    <span class="comment"># grep &#x27;=[ym]&#x27; $(LINUX_DIR)/.config.set | LC_ALL=C sort | $(MKHASH) md5 &gt; $(LINUX_DIR)/.vermagic</span></span><br><span class="line">    <span class="built_in">cp</span> $(TOPDIR)/.vermagic $(LINUX_DIR)/.vermagic</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将源中内核的后缀添加到immortalwrt源码根目录，后续内核编译时会将其拷贝到内核源码根目录并将其内容作为内核后缀</span></span><br><span class="line">leux@Debian:~/immortalwrt$ <span class="built_in">echo</span> <span class="string">&quot;9e686cc1e0d5129337ca1ca28c2ab984&quot;</span> &gt; ~/immortalwrt/.vermagic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后生成的内核包在：~/immortalwrt/bin/targets/rockchip/armv8/packages/kernel_6.6.93~9e686cc1e0d5129337ca1ca28c2ab984-r1_aarch64_generic.ipk</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷入该系统后可更换默认软件源为国内源，如下首行KMOD源即是上面后缀一致可用的官方内核模块源</span></span><br><span class="line">src/gz immortalwrt_kmod https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/targets/rockchip/armv8/kmods/6.6.93-1-9e686cc1e0d5129337ca1ca28c2ab984</span><br><span class="line">src/gz immortalwrt_core https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/targets/rockchip/armv8/packages</span><br><span class="line">src/gz immortalwrt_base https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/packages/aarch64_generic/base</span><br><span class="line">src/gz immortalwrt_luci https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/packages/aarch64_generic/luci</span><br><span class="line">src/gz immortalwrt_packages https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/packages/aarch64_generic/packages</span><br><span class="line">src/gz immortalwrt_routing https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/packages/aarch64_generic/routing</span><br><span class="line">src/gz immortalwrt_telephony https://mirrors.ustc.edu.cn/immortalwrt/releases/24.10.2/packages/aarch64_generic/telephony</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>将 RM500Q 从 USB 切换到 PCIE，需要用到开头配套的 <code>miniPCIE转5G转接板</code>，先在USB模式下通过AT命令切换成PCIE模式，然后再插到转接板上就行了</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：一旦切换为PCIE模式并重启后，/dev/ttyUSB* 之类的AT端口可能将失效，若你没有让模块支持PCIE模式的接口或转接板，还在USB接口下模块将因失去联系而无法调回</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这几个指令是模块重启才生效的，而模块PCIE下的驱动需要去上面菜单里面的 luci-app-qmodem 中选择及安装</span></span><br><span class="line">AT+QCFG=<span class="string">&quot;USBNET&quot;</span>,0</span><br><span class="line">AT+QCFG=<span class="string">&quot;pcie/mode&quot;</span>,0			<span class="comment"># 默认为 0: EP mode.    1: RC mode.  (PCIe运行模式：EP模式：外接设备，用电脑CPU。RC模式：主机模式，用模块的CPU)</span></span><br><span class="line">AT+QCFG=<span class="string">&quot;data_interface&quot;</span>,1,0		<span class="comment"># 切换为PCIE通信端口，只能是 1,0</span></span><br><span class="line">AT+QCFG=<span class="string">&quot;data_interface&quot;</span>,0,0		<span class="comment"># 切换为 USB通信端口，只能是 0,0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用QModem程序从终端切换为USB和PCIE的命令。若PCIE加载不上，可在计划项里添加：echo 1 &gt; /sys/bus/pci/rescan</span></span><br><span class="line">tom_modem -d /dev/ttyUSB2 -c <span class="string">&#x27;AT+QCFG=&quot;data_interface&quot;,0,0&#x27;</span></span><br><span class="line">tom_modem -d /dev/ttyUSB2 -c <span class="string">&#x27;AT+QCFG=&quot;data_interface&quot;,1,0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 出厂默认的为 USB 模式显示如下：</span></span><br><span class="line">AT+QCFG=<span class="string">&quot;pcie/mode&quot;</span> &gt;&gt; /dev/ttyUSB3</span><br><span class="line">AT+QCFG=<span class="string">&quot;pcie/mode&quot;</span></span><br><span class="line"></span><br><span class="line">+QCFG: <span class="string">&quot;pcie/mode&quot;</span>,0</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">AT+QCFG=&quot;data_interface&quot; &gt;&gt; /dev/ttyUSB3</span></span><br><span class="line"><span class="string">AT+QCFG=&quot;data_interface&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">+QCFG: &quot;data_interface&quot;,0,0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OK</span></span><br><span class="line"><span class="string">&lt;&lt;EOF</span></span><br><span class="line"></span><br><span class="line">———————————————————————————————————————————————————————————————————————————————————</span><br><span class="line">接口路径			|	主要功能			|	应用场景           |</span><br><span class="line">———————————————————————————————————————————————————————————————————————————————————</span><br><span class="line">/dev/mhi_BHI		|	Modem启动和寄存器访问	|	固件加载、硬件调试  |</span><br><span class="line">/dev/mhi_DIAG		|	诊断日志传输		|	信号分析、故障排查  |</span><br><span class="line">/dev/mhi_DUN		|	AT命令交互		|	拨号上网、设接入点  |</span><br><span class="line">/dev/mhi_LOOPBACK	|	数据环回测试		|	驱动验证、链路自检  |</span><br><span class="line">/dev/mhi_QMI0		|	QMI协议通信 控制 数据	|	模块管理及数据传输  |</span><br><span class="line">———————————————————————————————————————————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若切换PCIE后QModem中总是出现这个错误：【警告! SIM 错误，错误代码：miss】，可尝试关闭SIM卡热插拔</span></span><br><span class="line">AT+QSIMDET?			<span class="comment"># 查询当前状态</span></span><br><span class="line">AT+QSIMDET=0,0			<span class="comment"># 关闭热插拔</span></span><br><span class="line">AT+QSIMDET=1,1			<span class="comment"># 开启热插拔，拔插SIM卡会触发状态变更（1,0 表示拔卡）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>关于通过USB接入的FM350-GL在OpenWrt下命令行中手动拨号联网的方法</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分FM350-GL模块的AT命令及解释</span></span><br><span class="line">ATI			<span class="comment"># 查看当前模块信息</span></span><br><span class="line">AT+GTUSBMODE?		<span class="comment"># 查询当前模组端口模式，40 RNDIS+AT+AP(GNSS)+META+DEBUG+NPT+ADB，41 RNDIS+AT+AP(GNSS)+META+DEBUG+NPT+ADB+AP(LOG)+AP(META)(default value)</span></span><br><span class="line">AT+GTUSBMODE=41		<span class="comment"># 设置端口模式为41，后续手动拨号联网用的就是这个模式</span></span><br><span class="line">AT+CGDCONT=3,<span class="string">&quot;IPV4V6&quot;</span>,<span class="string">&quot;CTNET&quot;</span>		<span class="comment"># 设置APN，联通 3GNET，电信 CTNET，移动 CMNET</span></span><br><span class="line">AT+CGACT=1,3		<span class="comment"># 激活PDP拨号</span></span><br><span class="line">AT+CGPADDR=3		<span class="comment"># 查看分配的IPv4，然后把这个地址填写到你的RNDIS网卡上，网关为你获取的这个IPv4最后一段更改为 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从这里便开始用命令行手动拨号联网了，首先这里用sendat这个AT工具对 /dev/ttyUSB3 这个端口执行拨号及查看分配的IPv4命令</span></span><br><span class="line">sendat 3 <span class="string">&#x27;AT+CGDCONT=3,&quot;IPV4V6&quot;,&quot;CTNET&quot;&#x27;</span></span><br><span class="line">sendat 3 <span class="string">&#x27;AT+CGACT=1,3&#x27;</span></span><br><span class="line">sendat 3 <span class="string">&#x27;AT+CGPADDR=3&#x27;</span>			<span class="comment"># 假设其输出为：+CGPADDR: 3,&quot;10.4.65.212&quot;,&quot;0.0.0.0.0.0.0.0.24.105.32.53.113.77.169.92&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为wwan的IPv4静态地址接口, 物理接口名为FM350在OpenWrt中RNDIS变的eth2，其IP为上面获取到的 &quot;10.4.65.212&quot;，网关则为 &quot;10.4.65.1&quot;</span></span><br><span class="line">ip=<span class="string">&quot;10.4.65.212&quot;</span></span><br><span class="line">gateway=<span class="string">&quot;10.4.65.1&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan=interface</span><br><span class="line">uci <span class="built_in">set</span> network.wwan.proto=static</span><br><span class="line">uci <span class="built_in">set</span> network.wwan.ifname=eth2</span><br><span class="line">uci <span class="built_in">set</span> network.wwan.ipaddr=<span class="variable">$ip</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan.gateway=<span class="variable">$gateway</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan.netmask=255.255.255.0</span><br><span class="line">uci <span class="built_in">set</span> network.wwan.dns=<span class="string">&#x27;114.114.114.114&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为wwan6的IPv6接口，若不需要IPv6访问也可不创建</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6=interface</span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.proto=<span class="string">&#x27;dhcpv6&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.ifname=<span class="string">&#x27;@wwan&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.device=<span class="string">&#x27;@wwan&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.metric=<span class="string">&#x27;11&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.extendprefix=<span class="string">&#x27;1&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.reqaddress=<span class="string">&#x27;try&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.reqprefix=<span class="string">&#x27;auto&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> network.wwan6.norelease=<span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置完接口外还需要将WWAN等接口防火墙区域设置为WAN才能正常访问互联网</span></span><br><span class="line">uci del firewall.cfg03dc81.network</span><br><span class="line">uci add_list firewall.cfg03dc81.network=<span class="string">&#x27;wan&#x27;</span></span><br><span class="line">uci add_list firewall.cfg03dc81.network=<span class="string">&#x27;wan6&#x27;</span></span><br><span class="line">uci add_list firewall.cfg03dc81.network=<span class="string">&#x27;wwan&#x27;</span></span><br><span class="line">uci add_list firewall.cfg03dc81.network=<span class="string">&#x27;wwan6&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后一定要提交保存并重启才能使用</span></span><br><span class="line">uci commit network</span><br><span class="line">/etc/init.d/network reload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>其他零碎的小知识</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一个可查询软件包相关信息的网站：https://openwrt.pkgs.org/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 /usr/lib/opkg/status 和 /usr/lib/opkg/info/ 中存储着opkg已安装的软件包相关信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核补丁目录应用顺序，文件前面数字越小越先应用</span></span><br><span class="line">Applying /home/leux/openwrt/target/linux/generic/backport-6.6/</span><br><span class="line">Applying /home/leux/openwrt/target/linux/generic/pending-6.6/</span><br><span class="line">Applying /home/leux/openwrt/target/linux/generic/hack-6.6/</span><br><span class="line">Applying /home/leux/openwrt/target/linux/rockchip/patches-6.6/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核中查看相关硬件节点名及其温度</span></span><br><span class="line">cpu_thermal		<span class="built_in">cat</span> /sys/class/hwmon/hwmon0/name	<span class="built_in">cat</span> /sys/class/hwmon/hwmon0/temp1_input</span><br><span class="line">gpu_thermal		<span class="built_in">cat</span> /sys/class/hwmon/hwmon1/name	<span class="built_in">cat</span> /sys/class/hwmon/hwmon1/temp1_input</span><br><span class="line">ath11k_hwmon		<span class="built_in">cat</span> /sys/class/hwmon/hwmon2/name	<span class="built_in">cat</span> /sys/class/hwmon/hwmon2/temp1_input</span><br><span class="line">mt7915_phy0		<span class="built_in">cat</span> /sys/class/hwmon/hwmon3/name	<span class="built_in">cat</span> /sys/class/hwmon/hwmon3/temp1_input</span><br><span class="line">mt7915_phy1		<span class="built_in">cat</span> /sys/class/hwmon/hwmon4/name	<span class="built_in">cat</span> /sys/class/hwmon/hwmon4/temp1_input</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/openwrt/" rel="tag"><i class="fa fa-tag"></i> openwrt</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/doc/RK3588%E8%AE%BE%E5%A4%87H88K%E9%80%82%E9%85%8D%E4%B8%BB%E7%BA%BFU-Boot.html" rel="prev" title="RK3588设备H88K适配主线U-Boot">
                  <i class="fa fa-angle-left"></i> RK3588设备H88K适配主线U-Boot
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/doc/N150%E8%AE%BE%E5%A4%87%E4%BD%BF%E7%94%A8PVE%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8A%80%E5%B7%A7.html" rel="next" title="N150设备使用PVE系统的相关技巧">
                  N150设备使用PVE系统的相关技巧 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">湘ICP备2023036155号 </a>
  </div>
  <div class="copyright">
    &copy; 2016 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-user"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">leux</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://s4.zstatic.net/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/comments.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/utils.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/sidebar.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/next-boot.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/pjax.min.js"></script>

  <script src="https://s4.zstatic.net/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://s4.zstatic.net/ajax/libs/hexo-theme-next/8.22.0/third-party/search/local-search.min.js"></script>







  





</body>
</html>
